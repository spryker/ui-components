<ng-container *ngIf="addRowButton$ | async as addRowButton">
  <ng-container
    *spyTableFeatureTpl="
      tableLocation.beforeTable;
      styles: { display: 'flex', width: '100%' }
    "
  >
    <div style="flex-grow: 1;"></div>
    <spy-button [size]="buttonSize.Small" (click)="toggleAddMode(true)">
      <spy-icon *ngIf="addRowButton.icon" [name]="addRowButton.icon"></spy-icon>
      {{ addRowButton.title }}
    </spy-button>
  </ng-container>
</ng-container>

<ng-container *ngIf="mockColumnData$ | async as mockColumnData">
  <ng-container *ngIf="editColumns$ | async as editColumns">
    <ng-container *ngIf="isAddingMode">
      <ng-container
        *spyTableFeatureTpl="
          tableLocation.beforeRows;
          let columns = columns;
          let data = data
        "
      >
        <td *ngFor="let column of columns; let j = index">
          <spy-table-column-renderer
            [config]="getEditColumn | spyInvoke: column:editColumns"
            [data]="mockColumnData"
            [i]="0"
            [j]="j"
            (spy-table-editable)="onAddUpdated($event)"
          ></spy-table-column-renderer>
        </td>
        <td>
          <spy-button
            *ngIf="submitRowButton$ | async as submitRowButton"
            [size]="buttonSize.Small"
            [disabled]="isAddingInProgress || !addModelValid"
            (click)="submitAdd()"
          >
            <spy-icon
              *ngIf="submitRowButton.icon"
              [name]="submitRowButton.icon"
            ></spy-icon>
            {{ submitRowButton.title }}
          </spy-button>
          <spy-button
            *ngIf="cancelRowButton$ | async as cancelRowButton"
            [size]="buttonSize.Small"
            [variant]="buttonVariant.Secondary"
            [disabled]="isAddingInProgress"
            (click)="cancelAdd()"
          >
            <spy-icon
              *ngIf="cancelRowButton.icon"
              [name]="cancelRowButton.icon"
            ></spy-icon>
            {{ cancelRowButton.title }}
          </spy-button>
        </td>
      </ng-container>
    </ng-container>

    <ng-container
      *spyTableFeatureTpl="
        tableLocation.cell;
        let cellTpl;
        let cellContext = context;
        let config = config;
        let row = row;
        let value = value;
        let i = i;
        let j = j
      "
    >
      <div class="table-editable-container">
        <spy-popover
          [open]="isEditingCell | spyInvoke: editingCell:i:j"
          [position]="popoverPosition.Bottom"
          [popoverTrigger]="popoverTrigger.Click"
          (openChange)="toggleEditCell($event, i, j)"
        >
          <span
            trigger
            class="table-editable-wrapper"
            [class.editing]="isEditingCell | spyInvoke: editingCell:i:j"
            (click)="toggleEditCell(true, i, j)"
          >
            <ng-container
              *ngTemplateOutlet="cellTpl; context: cellContext"
            ></ng-container>
            <spy-icon [name]="editIcon"></spy-icon>
          </span>
          <div class="table-editable-content">
            <spy-table-column-renderer
              [config]="getEditColumn | spyInvoke: config:editColumns"
              [data]="row"
              [i]="i"
              [j]="j"
              (spy-table-editable)="onEditUpdated($event, i)"
            ></spy-table-column-renderer>
            <div class="table-editable-actions">
              <spy-button
                [size]="buttonSize.Small"
                [disabled]="isEditingInProgress || !editingModelValid"
                (click)="submitEdit(row, i, j)"
              >
                <spy-icon
                  class="table-editable-action"
                  [name]="checkIcon"
                ></spy-icon>
              </spy-button>

              <spy-button
                [size]="buttonSize.Small"
                [variant]="buttonVariant.Secondary"
                [disabled]="isEditingInProgress"
                (click)="cancelEdit(i, j)"
              >
                <spy-icon
                  class="table-editable-action"
                  [name]="removeIcon"
                ></spy-icon>
              </spy-button>
            </div>
          </div>
        </spy-popover>
      </div>
    </ng-container>
  </ng-container>
</ng-container>
